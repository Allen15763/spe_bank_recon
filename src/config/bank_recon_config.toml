# ============================================================
# SPE Bank Recon 配置檔案
# 銀行對帳與分期報表處理任務配置

# - **Manual的部分務必檢查後修改**

# ============================================================

[task]
    name = "bank_recon"
    description = "SPE 銀行對帳與分期報表處理任務"
    version = "2.0.1"

# ============================================================
# Pipeline 配置 (迭代 3 新增)
# ============================================================

[pipeline.bank_processing]
    # 啟用的銀行列表 (按處理順序)
    # 可在此控制哪些銀行參與處理，以及處理順序
    enabled_banks = ["cub", "ctbc", "nccc", "ub", "taishi"]

    # 處理模式
    # - "sequential": 順序處理（默認）
    # - "parallel": 並行處理（未來支持）
    processing_mode = "sequential"

    # 如果設置為 true，只處理 enabled=true 的銀行
    # 如果設置為 false，enabled_banks 列表中的銀行都會被處理
    respect_bank_enabled_flag = true

[dates]
    # 預設日期範圍 (可從命令列覆寫) - Manual
    current_period_start = "2026-01-01"
    current_period_end = "2026-01-31"
    last_period_start = "2025-12-01"
    last_period_end = "2025-12-31"

    # 日期格式
    date_format = "%Y-%m-%d"
    period_format = "%Y%m"

[database]
    path = "./db/bank_statements.duckdb"
    log_file = "./logs/duckdb_operations.log"
    log_level = "DEBUG"

[output]
    path = "./output/"
    escrow_filename = "Escrow_recon_{period}_renew.xlsx"
    trust_account_filename = "filing data for Trust Account Fee Accrual-SPETW.xlsx"
    add_timestamp = false

# ============================================================
# 業務規則配置 (每月調整-Manual)
# ============================================================

[business_rules]
    # 每月需要調整的參數
    # FRR 調扣，用於加回核算手續費發票數字，FRR上是負數要加負號
    # 讓sheet: apcc_validate_frr的差異數跟FRR調扣相同
    ops_taishi_adj_amt = 6252
    ops_cub_adj_amt =  -2083
    ops_ctbc_adj_amt = 0
    ops_nccc_adj_amt = 0

    # COD 匯費
    cod_remittance_fee = 8050  # 9740  
    ach_exps = 10194451  # 9163359  # 中信 ACH eACH EDI

    # 手續費尾差調整 (調成跟發票一致)
    taishi_service_fee_rounding = 0
    ctbc_service_fee_rounding = 2

    # 中信回饋金（若當月無則設為 0）
    ctbc_rebate_amt = 0  # 0


[business_rules.special_transactions]
    # 特殊日期交易配置 (如 received_ctbc_spt)
    # e.g. 1127-Received CTBC-SPT，by Email confirmed to topup
    # 詳細數字與日期可看DFR
    # 格式: "YYYY-MM-DD" = amount
    # 例如: 
    "2025-10-29" = 181432345
    "2025-11-27" =  175204850
    "2025-12-29" =  198032678
    "2026-01-28" =  195643924

# ============================================================
# 銀行配置
# ============================================================

[banks.cub]
    code = "cub"
    name = "國泰世華"
    enabled = true
    categories = ["individual", "nonindividual"]

[banks.cub.tables]
    individual = "cub_individual_statement"
    nonindividual = "cub_nonindividual_statement"

[banks.cub.fields]
    disbursement_date = "disbursement_date"
    request_amount = "request_amount"
    return_amount = "return_amount"
    handling_fee = "handling_fee"

[banks.ctbc]
    code = "ctbc"
    name = "中國信託"
    enabled = true
    categories = ["installment", "noninstallment"]

[banks.ctbc.tables]
    installment = "ctbc_installment"
    noninstallment = "ctbc_noninstallment"

[banks.ctbc.fields]
    request_date = "request_date"
    disbursement_date = "disbursement_date"
    request_amount = "request_amount"
    adjustment_amount = "adjustment_amount"
    adjustment_handling_fee = "adjustment_handling_fee"
    invoice_amount = "invoice_amount"
    handling_fee = "handling_fee"

[banks.nccc]
    code = "nccc"
    name = "NCCC"
    enabled = true
    categories = ["recon"]

[banks.nccc.tables]
    payment = "nccc_payment_statement"
    recon = "nccc_recon_statement"

[banks.nccc.fields]
    disbursement_date = "disbursement_date"
    request_date = "request_date"
    request_amount = "request_amount"
    handling_fee = "handling_fee"

[banks.ub]
    code = "ub"
    name = "聯邦"
    enabled = true
    categories = ["installment", "noninstallment"]

[banks.ub.tables]
    installment = "ub_installment_recon_statement"
    noninstallment = "ub_noninstallment_recon_statement"

[banks.ub.fields]
    disbursement_date = "disbursement_date"
    request_date = "request_date"
    request_amount = "request_amount"
    handling_fee = "handling_fee"
    store_name = "store_name"

[banks.ub.aggregation]
    target_stores = ["他行卡", "自行卡", "自行卡分期內含"]
    stop_row_identifier = "商店總計"
    main_company_name = "樂購蝦皮股份有限公司"
    adjustment_row_identifier = "調整 -- 退貨"

[banks.taishi]
    code = "taishi"
    name = "台新"
    enabled = true
    categories = ["default"]

[banks.taishi.tables]
    recon = "taishi_recon_statement"

[banks.taishi.fields]
    disbursement_date = "disbursement_date"
    request_amount = "request_amount"
    disbursement_amount = "disbursement_amount"
    invoice_amount = "invoice_amount"
    tax_amount = "tax_amount"

# ============================================================
# 分期報表配置
# ============================================================

[installment]
    enabled = true
    google_sheets_enabled = true
    service_fee_sheet_name = "service_fee_rate"

[installment.reports]
    # 報表路徑範本 ({period} 會被替換為期間，如 202510)
    ub = "./input/聯邦分期報表_{period}.xlsx"
    ctbc = "./input/CTBC手續費_{period}.xlsx"
    nccc = "./input/NCCC分期報表_{period}.xls"
    taishi = "./input/台新分期報表_{period}.xlsx"

[installment.reports.cub]
    cub_individual = "./input/國泰分期報表_個人_{period}.xls"
    # "./input/國泰分期報表_個人_{period}.xlsx"
    cub_nonindividual = "./input/國泰分期報表_法人_{period}.xls"

[installment.report_specs]
# 各銀行報表格式規格

[installment.report_specs.cub]
    sheet_name = "B2B_TimesM"
    header_row = 3
    dtype = "str"

[installment.report_specs.ctbc]
    # CTBC 有多個 sheet，需特殊處理
    process_all_sheets = true
    sheet_pattern = "\\d{4}"  # 符合年份的 sheet
    installment_usecols = "A:I"
    noninstallment_usecols = "B:I"
    header_row = 2

[installment.report_specs.nccc]
    header_row = 4
    dtype = "str"

[installment.report_specs.ub]
    header_row = 3
    dtype = "str"

[installment.report_specs.taishi]
    header_row = 2
    dtype = "str"
    sheets = [0, 1]  # 一般卡和 voucher

[installment.transaction_type_mapping]
    "03" = "3期"
    "06" = "6期"
    "12" = "12期"
    "24" = "24期"

# ============================================================
# 發票配置
# ============================================================

[invoice]
    table_name = "invoice_details"
    date_field = "invoice_date"
    date_format = "%Y%m%d"

[invoice.fields]
    category = "category"
    invoice_description = "invoice_description"
    amount_excl_tax = "amount_excl_tax"
    tax_amount = "tax_amount"
    amount_incl_tax = "amount_incl_tax"

# ============================================================
# 驗證規則
# ============================================================

[validation]
    tolerance = 1  # 金額容差
    enable_strict_mode = false

[validation.rules]
    check_balance = true
    check_service_fee = true
    check_invoice_mapping = true
    log_mismatches = true

# ============================================================
# Pipeline 配置
# ============================================================

[pipeline]
    stop_on_error = true
    save_checkpoints = true
    checkpoint_dir = "./checkpoints"

[pipeline.steps]
    # 原有步驟 (Step 1-9)
    load_parameters = true
    process_cub = true
    process_ctbc = true
    process_nccc = true
    process_ub = true
    process_taishi = true
    aggregate_escrow = true
    load_installment = true
    generate_trust_account = true

    # 新增步驟 (Step 10-17: Daily Check & Entry)
    load_daily_check_params = true
    process_frr = true
    process_dfr = true
    calculate_apcc = true
    validate_daily_check = true
    prepare_entries = true
    generate_big_entry = true
    output_workpaper = true

# ============================================================
# 輸出格式配置
# ============================================================

[output.bank_order]
    # 銀行在輸出中的順序
    escrow = [
        "taishi",
        "nccc",
        "cub_nonindividual",
        "cub_individual",
        "ctbc_noninstallment",
        "ctbc_installment",
        "ub_noninstallment",
        "ub_installment",
    ]


    trust_account = [
        "台新",
        "NCCC",
        "國泰",
        "CTBC",
        "聯邦"
    ]

[output.excel]
    # Excel 輸出設定
    freeze_panes = [1, 1]
    number_format = "#,##0"
    date_format = "yyyy-mm-dd"

# ============================================================
# 日誌配置
# ============================================================

[logging]
    level = "INFO"
    format = "detailed"
    log_to_console = true
    log_to_file = true

# ============================================================
# Daily Check 配置 (Step 10-14)
# ============================================================

[daily_check]
    enabled = true

# FRR (財務部) 檔案配置
[daily_check.frr]
    path = "./input/財務部-{period}.xlsx"
    sheet_name = "匯入款組成-樂購"
    header_row = 0

# FRR 欄位映射 (銀行順序: TSPG, CTBC, NCCC, CUB, UBOT)
[daily_check.frr.columns]
    date_col = "Date"
    # TSPG (台新): 4 columns
    tspg_cols = ["TSPG_Net_Billing", "TSPG_Handling_Fee", "TSPG_Adjustment", "TSPG_Net_Disbursement"]
    # CTBC (中信): 4 columns
    ctbc_cols = ["CTBC_Net_Billing", "CTBC_Handling_Fee", "CTBC_Adjustment", "CTBC_Net_Disbursement"]
    # NCCC: 4 columns
    nccc_cols = ["NCCC_Net_Billing", "NCCC_Handling_Fee", "NCCC_Adjustment", "NCCC_Net_Disbursement"]
    # CUB (國泰): 5 columns (多一個 Remittance_Fee)
    cub_cols = ["CUB_Net_Billing", "CUB_Handling_Fee", "CUB_Adjustment", "CUB_Remittance_Fee", "CUB_Net_Disbursement"]
    # UBOT (聯邦): 5 columns (Remittance_Fee 在 Adjustment 之前)
    ubot_cols = ["UBOT_Net_Billing", "UBOT_Handling_Fee", "UBOT_Remittance_Fee", "UBOT_Adjustment", "UBOT_Net_Disbursement"]

# 銀行名稱映射 (FRR欄位名 -> 顯示名)
[daily_check.frr.bank_mapping]
    TSPG = "台新"
    CTBC = "CTBC"
    NCCC = "NCCC"
    CUB = "國泰"
    UBOT = "聯邦"

# DFR (TW Bank Balance) 檔案配置
[daily_check.dfr]
    path = "./input/TW Bank Balance(NEW).xlsx"
    sheet_name = " CTBC SINCE 202108"
    header_row = 5

# DFR 欄位配置 (完全配置化)
[daily_check.dfr.columns]
    date_col = "Date"

    # Inbound 欄位範圍
    inbound_start_col = "BT"
    inbound_end_col = "Collection Shop"
    inbound_extra_cols = ["offline transfer"]

    # Inbound 驗證欄位清單
    inbound_validation_cols = [
        "BT",
        "CC\n(中國信託收單)",
        "CC\n(愛貝台新收單)",
        "CC\n(聯合信用卡中心)",
        "CC\n(國泰世華)",
        "CC\n(聯邦銀行)",
        "COD(蝦皮)",
        "7-11\n(統一數網)",
        "全家(FM)\n(日翊文化行銷)",
        "黑貓(HM)\n(統一客樂得)",
        "萊爾富(Hi Life)\n(萊爾富國際)",
        "來來超商(OK)\n(來來超商)",
        "宅配通\n(台灣宅配通)",
        "嘉里\n(嘉里快遞)",
        "新竹物流\n(ＨＣＴ新竹物流)",
        "蝦皮店到店(SPX)\n(新加坡商蝦皮娛)",
        "Collection Shop",
        "offline transfer"
    ]

    # Outbound 欄位清單
    outbound_cols = [
        76512178905003,
        "Digital Product Payment",
        "SVS",
        "715120012087 (OLD)\n715120019251 (NEW)",
        "Shopping Plus"
    ]
    outbound_extra_cols = [
        "Others",
        "Others.1",
        "Shopee Wallet",
        "COD RR",
        "個案撥款",
        "tax"
    ]

    # Outbound 驗證欄位清單
    outbound_validation_cols = [
        76512178905003,
        "Digital Product Payment",
        "SVS",
        "715120012087 (OLD)\n715120019251 (NEW)",
        "Shopping Plus",
        "Others",
        "Others.1",
        "Shopee Wallet",
        "COD RR",
        "個案撥款",
        "tax"
    ]

    # 其他特殊欄位
    unsuccessful_ach_start_col = "Unsuccessful\n(ACH)"
    unsuccessful_ach_end_col = "Unsuccessful (ACH)\nCOD RR"
    spl_col = "企網自行轉帳\n20680100228850"
    interest_col = "存款息"
    interbank_col = "Interbank\ntransfer"
    adj_col = "調撥"
    withdraw_service_fee_col = "手續費"
    balance_col = "Balance.1"

    # 從FRR加入，用FRR算出來的total數
    remittance_fee_col = "Grand Total"
    handing_fee_col = "Grand Total"

# ============================================================
# Entry 配置 (Step 15-17)
# ============================================================

[entry]
    enabled = true

    # 月度配置檔案路徑 (期初數、特殊分錄等每月變動的配置)
    monthly_config_path = "./src/config/bank_recon_entry_monthly.toml"

# 仲信手續費檔案
[entry.easyfund]
    path = "./input/仲信手續費_2026.xlsx"
    usecols = "A:K"

# 會計科目映射 (靜態配置，較少變動)
[entry.accounts]
    "101150" = "Cash in Bank - Fubon TWD 2087"
    "104171" = "Escrow Bank - CTBC TWD 4935"
    "111301" = "Tax Receivable - GST/VAT"
    "111302" = "Tax Receivable - WHT"
    "112001" = "Amount due from IC-APYTW"
    "112002" = "Unbilled Receivables-RC-SPTTW"
    "113101" = "Receivables from payment gateway"
    "200208" = "Receive on behalf of Shopee"
    "200601" = "Tax Payables - GST/VAT/WHT"
    "200701" = "Amount due to SPTTW-Escrow"
    "440001" = "Interest Income"
    "999995" = "Cash Clearing"

# 有子分類的科目
[entry.accounts_detail."460103"]
    APCC_ACH = "Commission charge-RC-SPTTW-ACH/eACH/EDI"
    "APCC_手續費" = "Commission charge-RC-SPTTW-APCC手續費"

[entry.accounts_detail."530006"]
    "收單_SPE" = "Bank transaction fee(Remittance fee)-收單-SPE"
    "回饋金" = "Bank transaction fee(Remittance fee)-CTBC收單手續費回饋金"
    "內扣CTBCCC匯費" = "Bank transaction fee(Remittance fee)-收單轉帳匯費"
    "COD匯費" = "Bank transaction fee(Remittance fee)-COD匯費"

# 交易類型排序 (靜態配置)
[entry.transaction_type_order]
    "期初數" = "00.期初數"
    "內扣_ctbc_cc_匯費" = "01.內扣_ctbc_cc_匯費"
    "received_ctbc_spt" = "02.received_ctbc_spt"
    "received_ctbc_spt_退匯" = "03.received_ctbc_spt_退匯"
    "out_ctbc_spt" = "04.out_ctbc_spt"
    "other" = "05.other"
    "other_利息" = "05.other_利息"
    "spt" = "06.spt"
    "spe_withdrawal" = "07.spe_withdrawal"
    "spl手續費調整" = "08.spl手續費調整"
    "發票已開立沖轉" = "09.發票已開立沖轉"

# 驗證配置
[entry.validation]
    # 排除零值驗證的交易類型
    exclude_zero_check = ["00.期初數", "09.發票已開立沖轉"]
    # 餘額檢核容差
    balance_tolerance = 1.0
    # 是否跳過零金額分錄
    skip_zero_amount = false
    # 金額小數位數
    amount_decimal_places = 2

# 分錄映射規則 (靜態配置，定義寬表格欄位到長表格分錄的轉換)
[[entry.entry_mapping]]
    column = "acc_200208_ReceivedCTBCSPT_negative"
    account_no = "200208"
    transaction_type = "received_ctbc_spt"

[[entry.entry_mapping]]
    column = "acc_200208_ReceivedCTBCSPT_positive"
    account_no = "200208"
    transaction_type = "received_ctbc_spt"

[[entry.entry_mapping]]
    column = "acc_200701_OutCTBCSPT"
    account_no = "200701"
    transaction_type = "out_ctbc_spt"

[[entry.entry_mapping]]
    column = "acc_200701_ReceivedCTBCSPT_negative"
    account_no = "200701"
    transaction_type = "received_ctbc_spt"

[[entry.entry_mapping]]
    column = "acc_200701_ReceivedCTBCSPT退匯"
    account_no = "200701"
    transaction_type = "received_ctbc_spt_退匯"

[[entry.entry_mapping]]
    column = "acc_530006_收單_SPE"
    account_no = "530006"
    transaction_type = "received_ctbc_spt"
    desc_key = "收單_SPE"

[[entry.entry_mapping]]
    column = "acc_530006_內扣CTBCCC匯費"
    account_no = "530006"
    transaction_type = "內扣_ctbc_cc_匯費"
    desc_key = "內扣CTBCCC匯費"

[[entry.entry_mapping]]
    column = "acc_101150_Received_CTBC_SPT"
    account_no = "101150"
    transaction_type = "received_ctbc_spt"

[[entry.entry_mapping]]
    column = "acc_104171_OutCTBCSPT"
    account_no = "104171"
    transaction_type = "out_ctbc_spt"

[[entry.entry_mapping]]
    column = "acc_104171_ReceivedCTBCSPT"
    account_no = "104171"
    transaction_type = "received_ctbc_spt"

[[entry.entry_mapping]]
    column = "acc_104171_ReceivedCTBCSPT退匯"
    account_no = "104171"
    transaction_type = "received_ctbc_spt_退匯"

[[entry.entry_mapping]]
    column = "acc_104171_內扣CTBCCC匯費"
    account_no = "104171"
    transaction_type = "內扣_ctbc_cc_匯費"

[[entry.entry_mapping]]
    column = "acc_104171_others"
    account_no = "104171"
    transaction_type = "other"

[[entry.entry_mapping]]
    column = "acc_104171_others_利息"
    account_no = "104171"
    transaction_type = "other_利息"

[[entry.entry_mapping]]
    column = "acc_999995_others"
    account_no = "999995"
    transaction_type = "other"

[[entry.entry_mapping]]
    column = "acc_440001_interest"
    account_no = "440001"
    transaction_type = "other_利息"

[[entry.entry_mapping]]
    column = "acc_111302_interest"
    account_no = "111302"
    transaction_type = "other_利息"

# ============================================================
# Google Sheets 配置
# ============================================================

[google_sheets]
    enabled = true
    spreadsheet_url = "https://docs.google.com/spreadsheets/d/17puiAmAhM2dAm9BR7Sck1E2fwsf0v76CkpiLkVJPlxE/edit?gid=0#gid=0"

# 輸入 (從 Google Sheets 讀取)
[google_sheets.input]
    spe_rate_sheet = "spe_rate"
    cub_rebate_sheet = "國泰回饋金"
    ctbc_rebate_sheet = "中信回饋金"
    acquiring_charge_history_sheet = "acquiring_charge_raw"
    apcc_history_sheet = "APCC 手續費"

# 輸出 (寫入 Google Sheets)
[google_sheets.output]
    acquiring_charge_raw_sheet = "acquiring_charge_raw"
    acquiring_charge_sum_display_sheet = "acquiring_charge_sum_display"
    big_entry_raw_sheet = "大entry_raw"
    big_entry_display_sheet = "大entry_display"
    cc_net_rev_sheet = "cc_net_rev"

# 寫入模式配置
[google_sheets.output.modes]
    acquiring_charge_raw = "append"
    acquiring_charge_sum_display = "overwrite"
    big_entry_raw = "append"
    big_entry_display = "overwrite"

# ============================================================
# Daily Check 輸出配置
# ============================================================

[output.daily_check]
    filename = "SPETW_daily_check_{period}_中信.xlsx"

    # Daily Check Excel 輸出的 Sheet 清單
    sheets = [
        "dfr",
        "dfr_wp",
        "frr_handling_fee",
        "frr_remittance_fee",
        "apcc_acquiring_charge",
        "apcc_validate_frr",
        "summary_01",
        "validate_frr_handling_fee",
        "validate_frr_net_billing",
        "extracted_from_frr"
    ]

[output.entry]
    filename = "TW_SPE_entries_{period}.xlsx"

    # Entry Excel 輸出的 Sheet 清單
    sheets = [
        "大entry",
        "104171 vs DFR",
        "分類驗證",
        "Entry Source Validation",
        "entry_temp",
        "entry_long_temp",
        "dfr",
        "dfr_detail",
        "dfr_wp",
        "summary_01",
        "APCC手續費",
        "apcc_validate_frr",
        "Trust account fee回補手續費",
        "trust_account_fee",
        "validate_frr_summary",
        "validate_frr_handling_fee",
        "validate_frr_net_billing",
        "frr_handling_fee",
        "frr_remittance_fee",
        "extracted_from_frr",
        "acquiring_charge_history",
        "APCC手續費_history"
    ]
